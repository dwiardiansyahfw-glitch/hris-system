<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ‘¥</text></svg>">

<style>
    /* Custom gradient background */
    .bg-gradient-hris {
        background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 50%, #1E3A8A 100%);
    }
    
    /* Spinner animation */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .spinner {
        animation: spin 1s linear infinite;
    }
    
    /* Fade in animation */
    @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(-10px); }
        100% { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    /* Pulse animation for logo */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .pulse {
        animation: pulse 2s ease-in-out infinite;
    }
</style>

<!-- Main Container -->
<div class="text-center px-4">
    
    <!-- Logo/Brand -->
    <div class="mb-8 fade-in">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-white/10 backdrop-blur-sm rounded-2xl mb-4 pulse">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
        </div>
        <h1 class="text-2xl font-bold text-white tracking-wide">HRIS</h1>
        <p class="text-blue-200 text-sm mt-1">HR Management System</p>
    </div>
    
    <!-- Loading State -->
    <div id="loadingState" class="fade-in">
        <div class="flex flex-col items-center justify-center">
            <!-- Spinner -->
            <div class="spinner w-10 h-10 border-4 border-white/30 border-t-white rounded-full mb-4"></div>
            <!-- Loading Text -->
            <p class="text-white text-lg font-medium">Memuat...</p>
            <p class="text-blue-200 text-sm mt-2">Memeriksa sesi login</p>
        </div>
    </div>
    
    <!-- Error State (Hidden by default) -->
    <div id="errorState" class="hidden fade-in">
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 max-w-sm mx-auto">
            <!-- Error Icon -->
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                <svg class="w-8 h-8 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <!-- Error Message -->
            <h2 class="text-white text-lg font-semibold mb-2">Terjadi Kesalahan</h2>
            <p id="errorMessage" class="text-blue-200 text-sm mb-6">Gagal memeriksa status login. Silakan coba lagi.</p>
            <!-- Retry Button -->
            <button id="retryButton" onclick="checkSession()" class="w-full bg-white text-blue-600 font-semibold py-3 px-6 rounded-xl hover:bg-blue-50 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-blue-600">
                <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Coba Lagi
                </span>
            </button>
            <!-- Manual Login Link -->
            <a href="login.html" class="inline-block mt-4 text-blue-200 hover:text-white text-sm transition-colors duration-200">
                atau langsung ke halaman login â†’
            </a>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="mt-12 fade-in">
        <p class="text-blue-300/60 text-xs">Â© 2025 HRIS System. All rights reserved.</p>
    </div>
    
</div>

<!-- Scripts -->
<script src="config.js"></script>
<script src="supabase-client.js"></script>
<script src="auth.js"></script>

<script>
    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');
    
    // Show loading state
    function showLoading() {
        loadingState.classList.remove('hidden');
        errorState.classList.add('hidden');
    }
    
    // Show error state
    function showError(message) {
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        errorMessage.textContent = message || 'Gagal memeriksa status login. Silakan coba lagi.';
    }
    
    // Redirect to page
    function redirectTo(page) {
        window.location.href = page;
    }
    
    // Check session and redirect accordingly
    async function checkSession() {
        showLoading();
        
        try {
            // Small delay for UX (shows loading state)
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // Check if supabase client is available
            if (typeof supabase === 'undefined') {
                throw new Error('Supabase client tidak tersedia. Periksa konfigurasi.');
            }
            
            // Get current session from Supabase
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                throw error;
            }
            
            if (session) {
                // User is logged in - redirect to dashboard
                console.log('User logged in, redirecting to dashboard...');
                redirectTo('dashboard.html');
            } else {
                // User is not logged in - redirect to login
                console.log('No session found, redirecting to login...');
                redirectTo('login.html');
            }
            
        } catch (error) {
            console.error('Session check error:', error);
            showError(error.message || 'Terjadi kesalahan saat memeriksa sesi.');
        }
    }
    
    // Listen for auth state changes (optional enhancement)
    function setupAuthListener() {
        if (typeof supabase !== 'undefined') {
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event);
                if (event === 'SIGNED_IN' && session) {
                    redirectTo('dashboard.html');
                }
            });
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Setup auth listener first
        setupAuthListener();
        
        // Then check current session
        checkSession();
    });
    
    // Fallback: If scripts fail to load, show error after timeout
    setTimeout(() => {
        if (typeof supabase === 'undefined') {
            showError('Gagal memuat aplikasi. Periksa koneksi internet Anda.');
        }
    }, 5000);
</script>
